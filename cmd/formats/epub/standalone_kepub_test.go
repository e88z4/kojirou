package epub_test

import (
	"os"
	"path/filepath"
	"testing"

	"github.com/bmaupin/go-epub"
	kepubconv "github.com/leotaku/kojirou/cmd/formats/kepubconv"
)

// TestBasicKEPUBConversion tests the basic KEPUB conversion functionality
// This test is designed to avoid import cycles
func TestBasicKEPUBConversion(t *testing.T) {
	// Create a simple EPUB
	e := epub.NewEpub("Test KEPUB")
	e.SetAuthor("Test Author")

	// Add a section
	_, err := e.AddSection("<h1>Test Chapter</h1><p>This is a test.</p>", "Chapter 1", "ch1", "")
	if err != nil {
		t.Fatalf("Failed to add section: %v", err)
	}

	// Add an image section
	tempDir, err := os.MkdirTemp("", "kepub-test")
	if err != nil {
		t.Fatalf("Failed to create temp directory: %v", err)
	}
	defer os.RemoveAll(tempDir)

	// Create a simple 1x1 pixel image
	imgPath := filepath.Join(tempDir, "test.jpg")
	if err := os.WriteFile(imgPath, []byte{
		0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46, 0x49, 0x46, 0x00, 0x01,
		0x01, 0x01, 0x00, 0x48, 0x00, 0x48, 0x00, 0x00, 0xFF, 0xDB, 0x00, 0x43,
		0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xC2, 0x00, 0x0B, 0x08, 0x00, 0x01, 0x00, 0x01, 0x01, 0x01, 0x11,
		0x00, 0xFF, 0xC4, 0x00, 0x14, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xDA,
		0x00, 0x08, 0x01, 0x01, 0x00, 0x00, 0x3F, 0x00, 0x7F, 0x00, 0xFF, 0xD9,
	}, 0644); err != nil {
		t.Fatalf("Failed to create test image: %v", err)
	}

	// Add image to EPUB
	testImg, err := e.AddImage(imgPath, "test.jpg")
	if err != nil {
		t.Fatalf("Failed to add image: %v", err)
	}

	// Add an image section
	_, err = e.AddSection(
		"<div><h1>Image Test</h1><img src=\""+testImg+"\" alt=\"Test Image\"></div>",
		"Image Chapter", "img-ch", "",
	)
	if err != nil {
		t.Fatalf("Failed to add image section: %v", err)
	}

	// Convert to KEPUB
	kepubData, err := kepubconv.ConvertToKEPUB(e)
	if err != nil {
		t.Fatalf("ConvertToKEPUB() failed: %v", err)
	}

	if len(kepubData) == 0 {
		t.Error("KEPUB data is empty")
	}

	// Write KEPUB to file for inspection (optional)
	kepubPath := filepath.Join(tempDir, "test.kepub.epub")
	if err := os.WriteFile(kepubPath, kepubData, 0644); err != nil {
		t.Logf("Failed to write KEPUB to file: %v", err)
	} else {
		t.Logf("Created KEPUB at: %s", kepubPath)
	}
}
